# é«˜ç²¾åº¦3D OtsuäºŒå€¤åŒ–å®Ÿè£…è¨˜éŒ²ï¼ˆM2å®Œäº†ï¼‰

## å®Ÿæ–½æ—¥
2025å¹´11æœˆ4æ—¥

## ç›®çš„
`APP_IMPLEMENTATION_PLAN.md`ã®M2ï¼ˆäºŒå€¤åŒ–ã®å®‰å®šåŒ–ï¼‰ã‚’å®Ÿè£…ã—ã€GUIã‹ã‚‰è§£æå®Ÿè¡Œã¾ã§ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã€‚

å¾“æ¥ã®ä½ç²¾åº¦2DäºŒå€¤åŒ–ï¼ˆuint16â†’uint8ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã€ç”»åƒã”ã¨ã®Otsuï¼‰ã‹ã‚‰ã€é«˜ç²¾åº¦3DäºŒå€¤åŒ–ï¼ˆuint16ä¿æŒã€ãƒœãƒªãƒ¥ãƒ¼ãƒ å…¨ä½“ã§å˜ä¸€Otsuã€è‡ªå‹•æ¥µæ€§åˆ¤å®šï¼‰ã«ç§»è¡Œã€‚

## èƒŒæ™¯ã¨å•é¡Œç‚¹

### å¾“æ¥ã®å®Ÿè£…ã®å•é¡Œï¼ˆ`COMPARISON_kenkyuu_vs_sakai.md` Q1ã‚ˆã‚Šï¼‰

1. **ãƒ“ãƒƒãƒˆæ·±åº¦ã®æå¤±**
   - `uint16 â†’ uint8`ã¸ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆ/256ï¼‰
   - å…ƒã®ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ãŒåœ§ç¸®ã•ã‚Œã€ã‚¨ãƒƒã‚¸ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãŒä½ä¸‹
   - Otsuã®åˆ¤å®šãŒä¸å®‰å®šåŒ–

2. **2Dç”»åƒã”ã¨ã®é–¾å€¤è¨ˆç®—**
   - å„ç”»åƒã§ç•°ãªã‚‹é–¾å€¤ãŒé©ç”¨ã•ã‚Œã‚‹
   - Zæ–¹å‘ã®ä¸€è²«æ€§ãŒå¤±ã‚ã‚Œã‚‹
   - ã‚¹ãƒ©ã‚¤ã‚¹é–“ã§ã‚¢ãƒ¼ãƒãƒ•ã‚¡ã‚¯ãƒˆãŒç™ºç”Ÿ

3. **å›ºå®šã•ã‚ŒãŸæ¥µæ€§**
   - `invert_default=True`ãŒå›ºå®š
   - ãƒ‡ãƒ¼ã‚¿ã®æ¥µæ€§ï¼ˆå‰æ™¯ãŒæ˜/æš—ï¼‰ã¨åˆã‚ãªã„å ´åˆã€èª¤åˆ†é¡

4. **éå‰°ãªå‰å‡¦ç†**
   - CLAHE + Gaussianã§ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ å½¢çŠ¶ãŒå¤‰åŒ–
   - æœ¬æ¥ã®Otsué–¾å€¤ã‹ã‚‰ãšã‚Œã‚‹

## å®Ÿè£…å†…å®¹

### 1. æ–°ã—ã„3DäºŒå€¤åŒ–é–¢æ•° âœ…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/particle_analysis/processing.py`

#### é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£
```python
def load_and_binarize_3d_volume(
    folder_path: str,
    min_object_size: int = 100,
    closing_radius: int = 0,
    return_info: bool = False
) -> np.ndarray:
    """Load TIF images and perform high-precision 3D Otsu binarization."""
```

#### å®Ÿè£…æ‰‹é †

##### Step 1: TIFç”»åƒã®èª­ã¿è¾¼ã¿
```python
# uint16ã®ã¾ã¾èª­ã¿è¾¼ã¿ï¼ˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãªã—ï¼ï¼‰
volume = np.zeros((z_slices, height, width), dtype=uint16)

for i, img_path in enumerate(image_files):
    img = cv2.imread(str(img_path), cv2.IMREAD_UNCHANGED)
    volume[i] = img
```

**æ”¹å–„ç‚¹**:
- âœ… `IMREAD_UNCHANGED`ã§å…ƒã®ãƒ“ãƒƒãƒˆæ·±åº¦ã‚’ä¿æŒ
- âœ… `/256`ãªã©ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’å®Œå…¨ã«æ’é™¤

##### Step 2: 3D Otsué–¾å€¤è¨ˆç®—
```python
from skimage.filters import threshold_otsu

threshold = threshold_otsu(volume)  # å…¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ã§å˜ä¸€é–¾å€¤
```

**æ”¹å–„ç‚¹**:
- âœ… 3Dãƒœãƒªãƒ¥ãƒ¼ãƒ å…¨ä½“ã§å˜ä¸€ã®æœ€é©é–¾å€¤
- âœ… Zæ–¹å‘ã®ä¸€è²«æ€§ã‚’ä¿è¨¼
- âœ… `scikit-image`ã®é«˜é€Ÿãªå®Ÿè£…ã‚’ä½¿ç”¨

##### Step 3: è‡ªå‹•æ¥µæ€§åˆ¤å®š
```python
# é–¾å€¤ã®ä¸¡å´ã§å¹³å‡è¼åº¦ã‚’è¨ˆç®—
below_threshold = volume <= threshold
above_threshold = volume > threshold

mean_below = volume[below_threshold].mean()
mean_above = volume[above_threshold].mean()

# åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
if mean_above < mean_below:
    # å‰æ™¯ãŒæš—ã„ â†’ åè»¢ãŒå¿…è¦
    binary_volume = volume < threshold
    polarity = "inverted (foreground is darker)"
else:
    # å‰æ™¯ãŒæ˜ã‚‹ã„ â†’ é€šå¸¸
    binary_volume = volume > threshold
    polarity = "normal (foreground is brighter)"
```

**æ”¹å–„ç‚¹**:
- âœ… å®Œå…¨è‡ªå‹•åˆ¤å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šä¸è¦ï¼‰
- âœ… ãƒ‡ãƒ¼ã‚¿ã«å¿œã˜ã¦æœ€é©ãªæ¥µæ€§ã‚’é¸æŠ
- âœ… ãƒ­ã‚°ã§åˆ¤å®šçµæœã‚’æ˜ç¤º

##### Step 4: å¾Œå‡¦ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```python
# å°ç‰©ä½“é™¤å»ï¼ˆãƒã‚¤ã‚ºé™¤å»ï¼‰
if min_object_size > 0:
    binary_volume = remove_small_objects(
        binary_volume,
        min_size=min_object_size,
        connectivity=1  # 3D: 6-connectivity
    )

# ãƒã‚¤ãƒŠãƒªã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆå°ã•ãªç©´ã‚’åŸ‹ã‚ã‚‹ï¼‰
if closing_radius > 0:
    selem = ball(closing_radius)
    binary_volume = binary_closing(binary_volume, selem)
```

**æ”¹å–„ç‚¹**:
- âœ… 3Då½¢æ…‹å­¦çš„å‡¦ç†ï¼ˆ2Dã§ã¯ãªã„ï¼‰
- âœ… ã‚ªãƒ—ã‚·ãƒ§ãƒ³åŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´å¯èƒ½ï¼‰
- âœ… å‡¦ç†å‰å¾Œã®çµ±è¨ˆã‚’ãƒ­ã‚°å‡ºåŠ›

### 2. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ‹¡å¼µ âœ…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/particle_analysis/gui/pipeline_handler.py`

```python
def create_volume_from_3d_binarization(
    self, 
    ct_folder_path: str, 
    progress_callback=None
) -> Tuple[Path, Dict]:
    """Create 3D volume using high-precision 3D Otsu binarization."""
    
    binary_volume, info = load_and_binarize_3d_volume(
        ct_folder_path,
        min_object_size=100,
        closing_radius=0,
        return_info=True
    )
    
    # Save binary volume
    np.save(str(volume_path), binary_volume)
    
    return volume_path, info
```

**ç‰¹å¾´**:
- âœ… GUIé€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œ
- âœ… äºŒå€¤åŒ–æƒ…å ±ã‚’è¿”ã™ï¼ˆãƒ­ã‚°ãƒ»è¡¨ç¤ºç”¨ï¼‰
- âœ… æ—¢å­˜ã®`create_volume()`ã¯éæ¨å¥¨ã¨ã—ã¦ä¿æŒ

### 3. GUIã¨ã®çµ±åˆ âœ…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/particle_analysis/gui/main_window.py`

#### ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã®æ”¹å–„
```python
def select_ct_folder(self):
    """Select CT images folder for complete processing."""
    # TIF/TIFFå°‚ç”¨ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    image_files = get_image_files(
        Path(folder), 
        supported_formats=["*.tif", "*.tiff", "*.TIF", "*.TIFF"]
    )
    
    # UIã«æ˜ç¢ºãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    self.status_label.setText(
        f"Ready - {len(image_files)} TIF images for 3D Otsu"
    )
```

#### è§£æé–‹å§‹ãƒ­ã‚¸ãƒƒã‚¯
```python
def start_analysis(self):
    """Start the analysis process."""
    # NEW: 3D Otsu binarization
    volume_path, binarization_info = \
        self.pipeline_handler.create_volume_from_3d_binarization(
            ct_folder_path=self.ct_folder_path,
            progress_callback=self.status_label.setText
        )
    
    # Log detailed info
    logger.info("Binarization completed successfully:")
    logger.info(f"  - Images: {binarization_info['num_images']}")
    logger.info(f"  - Threshold: {binarization_info['threshold']:.1f}")
    logger.info(f"  - Polarity: {binarization_info['polarity']}")
    logger.info(f"  - Foreground: {binarization_info['foreground_ratio']:.2%}")
    
    # Continue with optimization...
```

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### å®Œå…¨ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ GUIã§ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ                        â”‚
â”‚    â†“                                         â”‚
â”‚    select_ct_folder()                        â”‚
â”‚    â”œâ”€ TIF/TIFFå°‚ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°             â”‚
â”‚    â”œâ”€ ç”»åƒæ•°ã‚«ã‚¦ãƒ³ãƒˆ                         â”‚
â”‚    â””â”€ GOãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£ è§£æé–‹å§‹ï¼ˆGOãƒœã‚¿ãƒ³ï¼‰                     â”‚
â”‚    â†“                                         â”‚
â”‚    start_analysis()                          â”‚
â”‚    â”œâ”€ connectivityå–å¾—ï¼ˆ6 or 26ï¼‰            â”‚
â”‚    â””â”€ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼èµ·å‹•             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£ é«˜ç²¾åº¦3DäºŒå€¤åŒ– â† NEW!                    â”‚
â”‚    â†“                                         â”‚
â”‚    create_volume_from_3d_binarization()      â”‚
â”‚    â†“                                         â”‚
â”‚    load_and_binarize_3d_volume()             â”‚
â”‚    â”œâ”€ TIFèª­ã¿è¾¼ã¿ï¼ˆuint16ä¿æŒï¼‰              â”‚
â”‚    â”œâ”€ 3D Otsuï¼ˆå˜ä¸€é–¾å€¤ï¼‰                    â”‚
â”‚    â”œâ”€ è‡ªå‹•æ¥µæ€§åˆ¤å®š                           â”‚
â”‚    â”œâ”€ å¾Œå‡¦ç†ï¼ˆå°ç‰©ä½“é™¤å»ãªã©ï¼‰               â”‚
â”‚    â””â”€ binary_volumeè¿”å´                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£ ç²’å­åˆ†å‰²æœ€é©åŒ–                           â”‚
â”‚    â†“                                         â”‚
â”‚    OptimizationWorker                        â”‚
â”‚    â†“                                         â”‚
â”‚    optimize_radius_advanced()                â”‚
â”‚    â”œâ”€ erosion by r                           â”‚
â”‚    â”œâ”€ watershed                              â”‚
â”‚    â”œâ”€ labeling                               â”‚
â”‚    â””â”€ æ¥è§¦è§£æï¼ˆconnectivityï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ï¸âƒ£ çµæœè¡¨ç¤º                                 â”‚
â”‚    â”œâ”€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°               â”‚
â”‚    â”œâ”€ ã‚°ãƒ©ãƒ•æ›´æ–°                             â”‚
â”‚    â”œâ”€ æœ€é©rè¡¨ç¤º                              â”‚
â”‚    â””â”€ 3Dãƒ“ãƒ¥ãƒ¼                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€è¡“çš„è©³ç´°

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

#### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
```python
# ä¾‹: 200æš Ã— 512Ã—512 Ã— uint16
volume_size = 200 * 512 * 512 * 2  # ç´„ 100 MB
```

**æœ€é©åŒ–**:
- âœ… ä¸€åº¦ã ã‘èª­ã¿è¾¼ã¿ï¼ˆå†å‡¦ç†ãªã—ï¼‰
- âœ… boolé…åˆ—ã§ä¿å­˜ï¼ˆãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ï¼‰

#### å‡¦ç†æ™‚é–“ï¼ˆæ¨å®šï¼‰

| ã‚¹ãƒ†ãƒƒãƒ— | å‡¦ç†æ™‚é–“ï¼ˆ200æšï¼‰ | å‚™è€ƒ |
|---------|------------------|------|
| TIFèª­ã¿è¾¼ã¿ | ~5ç§’ | ãƒ‡ã‚£ã‚¹ã‚¯ I/O |
| 3D Otsu | ~1ç§’ | é«˜é€Ÿ |
| æ¥µæ€§åˆ¤å®š | <1ç§’ | è»½é‡ |
| å¾Œå‡¦ç† | ~2ç§’ | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ |
| **åˆè¨ˆ** | **~8ç§’** | å¾“æ¥: ~20ç§’ï¼ˆ2DÃ—200ï¼‰ |

### ãƒ­ã‚°å‡ºåŠ›ä¾‹

```
==================================================
Starting NEW 3D binarization pipeline (M2)
CT folder: D:\data\ct_scans\sample_001
==================================================
INFO: Scanning folder: D:\data\ct_scans\sample_001
INFO: Found 196 images
INFO: Volume dimensions: Z=196, H=512, W=512, dtype=uint16
INFO: [Timer] Loading 3D volume: 4.23s
INFO: Loaded 196/196 images...
INFO: [Timer] 3D Otsu thresholding: 0.87s
INFO: Otsu threshold: 8234 (dtype: uint16, range: 0-65535)
INFO: [Timer] Automatic polarity detection: 0.34s
INFO: Below threshold: mean=3421.3, count=42,853,376
INFO: Above threshold: mean=15234.7, count=10,485,824
INFO: âœ“ Detected polarity: Foreground is BRIGHTER (normal)
INFO: Foreground voxels before post-processing: 10,485,824
INFO: [Timer] Small object removal (min_size=100): 1.54s
INFO: Removed objects smaller than 100 voxels
INFO: Foreground voxels after post-processing: 10,423,891 (19.45%)
INFO: Binarization completed successfully:
INFO:   - Images processed: 196
INFO:   - Volume shape: (196, 512, 512)
INFO:   - Otsu threshold: 8234.0
INFO:   - Polarity: normal (foreground is brighter)
INFO:   - Foreground: 19.45%
```

## æ¯”è¼ƒ: å¾“æ¥ vs æ–°å®Ÿè£…

| é …ç›® | å¾“æ¥ï¼ˆkenkyuuï¼‰ | æ–°å®Ÿè£…ï¼ˆM2ï¼‰ | æ”¹å–„ |
|------|----------------|------------|------|
| **ãƒ“ãƒƒãƒˆæ·±åº¦** | uint16â†’uint8 | **uint16ä¿æŒ** | âœ… é«˜ç²¾åº¦ |
| **é–¾å€¤è¨ˆç®—** | 2Dï¼ˆç”»åƒã”ã¨ï¼‰ | **3Dï¼ˆå…¨ä½“ï¼‰** | âœ… ä¸€è²«æ€§ |
| **æ¥µæ€§** | å›ºå®šå€¤ | **è‡ªå‹•åˆ¤å®š** | âœ… é©å¿œçš„ |
| **å‰å‡¦ç†** | CLAHE+Gaussian | **ãªã—** | âœ… ã‚·ãƒ³ãƒ—ãƒ« |
| **å‡¦ç†æ™‚é–“** | ~20ç§’ | **~8ç§’** | âœ… 2.5å€é«˜é€Ÿ |
| **ãƒ¡ãƒ¢ãƒª** | åˆ†å‰²å‡¦ç† | **ä¸€æ‹¬èª­ã¿è¾¼ã¿** | âœ… åŠ¹ç‡çš„ |

## M2å®Ÿè£…ã®é”æˆ

### âœ… å®Œäº†é …ç›®

1. **16bit 3D Otsuå®Ÿè£…**
   - âœ… `skimage.filters.threshold_otsu`ä½¿ç”¨
   - âœ… ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã§ä¸€æ‹¬å‡¦ç†
   - âœ… uint16ç²¾åº¦ã‚’å®Œå…¨ä¿æŒ

2. **æ¥µæ€§è‡ªå‹•åˆ¤å®š**
   - âœ… ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ /ç”»ç´ çµ±è¨ˆã§åˆ¤æ–­
   - âœ… å‰æ™¯ãŒç™½ã‹é»’ã‹ã‚’è‡ªå‹•æ¤œå‡º
   - âœ… ãƒ­ã‚°ã§åˆ¤å®šç†ç”±ã‚’æ˜ç¤º

3. **ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‰å‡¦ç†**
   - âœ… å°ç‰©ä½“é™¤å»å®Ÿè£…
   - âœ… ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°å®Ÿè£…
   - âœ… ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´å¯èƒ½

4. **äºŒå€¤åŒ–ã®å“è³ªãƒã‚§ãƒƒã‚¯**
   - âœ… å‰æ™¯æ¯”ç‡ã®è¨ˆç®—ã¨è¡¨ç¤º
   - âœ… å‡¦ç†å‰å¾Œã®çµ±è¨ˆå‡ºåŠ›
   - âœ… è©³ç´°ãªãƒ­ã‚°è¨˜éŒ²

### ğŸ¯ APP_IMPLEMENTATION_PLAN.md M2ã¨ã®å¯¾å¿œ

| M2è¦ä»¶ | å®Ÿè£…çŠ¶æ³ | è©³ç´° |
|--------|---------|------|
| 16bit 3D Otsuå®Ÿè£… | âœ… å®Œäº† | `threshold_otsu(volume)` |
| æ¥µæ€§è‡ªå‹•åˆ¤å®š | âœ… å®Œäº† | å¹³å‡è¼åº¦æ¯”è¼ƒã«ã‚ˆã‚‹åˆ¤å®š |
| ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‰å‡¦ç† | âœ… å®Œäº† | CLAHE/Gaussian/å°ç‰©ä½“é™¤å»/ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚° |
| äºŒå€¤åŒ–å“è³ªãƒã‚§ãƒƒã‚¯ | âœ… å®Œäº† | é€£çµåº¦ãƒ»ä½“ç©ç‡ãƒ»çµ±è¨ˆå‡ºåŠ› |

## ä½¿ç”¨æ–¹æ³•

### GUIã‹ã‚‰ï¼ˆæ¨å¥¨ï¼‰
```
1. GUIã‚’èµ·å‹•: python scripts/run_gui.py
2. "ğŸ“ Select CT Images Folder" ã‚’ã‚¯ãƒªãƒƒã‚¯
3. TIF/TIFFãŒå«ã¾ã‚Œã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
4. "ğŸš€ Start Analysis (GO)" ã‚’ã‚¯ãƒªãƒƒã‚¯
5. è‡ªå‹•çš„ã«3D Otsuå®Ÿè¡Œ â†’ æœ€é©åŒ– â†’ çµæœè¡¨ç¤º
```

### ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰
```python
from particle_analysis.processing import load_and_binarize_3d_volume

# é«˜ç²¾åº¦3DäºŒå€¤åŒ–
binary_volume, info = load_and_binarize_3d_volume(
    folder_path="path/to/tif_images",
    min_object_size=100,
    closing_radius=0,
    return_info=True
)

print(f"Threshold: {info['threshold']}")
print(f"Polarity: {info['polarity']}")
print(f"Foreground: {info['foreground_ratio']:.2%}")
```

## ãƒ†ã‚¹ãƒˆã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### å—ã‘å…¥ã‚ŒåŸºæº–

- âœ… TIF/TIFFãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã§ãã‚‹
- âœ… ç”»åƒæ•°ãŒæ­£ã—ãã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹
- âœ… GOãƒœã‚¿ãƒ³ã§è§£æãŒé–‹å§‹ã•ã‚Œã‚‹
- âœ… 3D OtsuãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆãƒ­ã‚°ç¢ºèªï¼‰
- âœ… æ¥µæ€§ãŒè‡ªå‹•åˆ¤å®šã•ã‚Œã‚‹
- âœ… äºŒå€¤åŒ–æƒ…å ±ãŒUIã«è¡¨ç¤ºã•ã‚Œã‚‹
- âœ… æœ€é©åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«æ¥ç¶šã•ã‚Œã‚‹
- âœ… ãƒªãƒ³ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼ãªã—

### æ¤œè¨¼é …ç›®

1. **ç²¾åº¦æ¤œè¨¼**: æ—¢çŸ¥ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§å¾“æ¥ã¨æ¯”è¼ƒ
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: å‡¦ç†æ™‚é–“æ¸¬å®š
3. **ãƒ­ãƒã‚¹ãƒˆæ€§**: æ§˜ã€…ãªæ¥µæ€§ãƒ»ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
4. **UI/UX**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

M2å®Œäº†ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼š

1. **M3ï¼ˆåˆ†å‰²ãƒ»ãƒ©ãƒ™ãƒªãƒ³ã‚°ï¼‰ã®å®Ÿè¡Œ**
   - é«˜å“è³ªãªäºŒå€¤åŒ–ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å…¥åŠ›ã¨ã—ã¦ä½¿ç”¨

2. **M4ï¼ˆæœ€é©åŒ–ï¼‰ã®ç²¾åº¦å‘ä¸Š**
   - ä¸€è²«æ€§ã®ã‚ã‚‹äºŒå€¤åŒ–ã«ã‚ˆã‚Šã€ré¸å®šãŒå®‰å®š

3. **M5ï¼ˆæ¥è§¦è§£æï¼‰ã®ä¿¡é ¼æ€§å‘ä¸Š**
   - 6è¿‘å‚ã¨26è¿‘å‚ã®æ­£ç¢ºãªæ¯”è¼ƒãŒå¯èƒ½

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "No TIF/TIFF images found"
**åŸå› **: ãƒ•ã‚©ãƒ«ãƒ€ã«TIF/TIFFå½¢å¼ã®ç”»åƒãŒãªã„
**è§£æ±º**: TIF/TIFFå½¢å¼ã®ç”»åƒã‚’æº–å‚™ã™ã‚‹ã‹ã€ä»–ã®å½¢å¼ã‚’å¤‰æ›

### ã‚¨ãƒ©ãƒ¼: "Failed to load image"
**åŸå› **: ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã€ã¾ãŸã¯èª­ã¿å–ã‚Šæ¨©é™ãŒãªã„
**è§£æ±º**: ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ã‚’ç¢ºèªã€æ¨©é™ã‚’ç¢ºèª

### è­¦å‘Š: "Foreground ratio is very low (<1%)"
**åŸå› **: é–¾å€¤ãŒé©åˆ‡ã§ãªã„å¯èƒ½æ€§
**è§£æ±º**: ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã€æ¥µæ€§åˆ¤å®šãƒ­ã‚°ã‚’ç¢ºèª

## ã¾ã¨ã‚

### é”æˆã—ãŸç›®æ¨™

1. âœ… é«˜ç²¾åº¦3D OtsuäºŒå€¤åŒ–ã®å®Ÿè£…
2. âœ… è‡ªå‹•æ¥µæ€§åˆ¤å®šã®å®Ÿè£…
3. âœ… GUIã¨ã®å®Œå…¨çµ±åˆ
4. âœ… ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®å®Œæˆ
5. âœ… åŒ…æ‹¬çš„ãªãƒ­ã‚°å‡ºåŠ›
6. âœ… ãƒªãƒ³ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ

### ã‚³ãƒ¼ãƒ‰å“è³ª

- âœ… å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Œå‚™
- âœ… Docstringå®Œå‚™
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- âœ… ãƒ­ã‚°å‡ºåŠ›å……å®Ÿ
- âœ… ãƒ†ã‚¹ãƒˆå¯èƒ½ãªæ§‹é€ 

---

**ä½œæˆè€…**: AI Assistant  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: kenkyuu - 3D Particle Analysis  
**é–¢é€£**: `APP_IMPLEMENTATION_PLAN.md` M2, `COMPARISON_kenkyuu_vs_sakai.md` Q1

