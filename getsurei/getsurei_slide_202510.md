# 3D 粒子解析パイプライン「これまでの実装の理解と可視化」

## 1. 導入 (Introduction)

### 今月の研究目的（リネーミング）

**「実装の見える化と指標の正しい理解」**

- これまで作ってきた処理の全体像を“やさしく”言語化
- どの操作が、どんな処理を呼び出し、最終的に何が出力されるかを分解
- 特に、r（エロージョン半径）の決め方に使う 3 指標（HHI/膝点/VI）を、数式・直感・意義の 3 層で解説

---

## 2. そもそもの目的（なぜやるの？）

- **課題**: CT 画像上でくっついた粒子を無理なく分けたい（過不足なく）
- **目標**: 「分け過ぎず」「分け足りず」を避け、誰でも納得できる分割パラメータ r を選ぶ
- **要件**:
  - 自動で客観的に決める（人の主観に依存しない）
  - なぜその r が良いのか説明できる（説明可能性）
  - GUI 上で結果を見て理解できる（可視化）

---

## 3. 全体フロー（入力 → 処理 → 出力）

```
入力（CT画像フォルダ）
   ↓ 前処理（二値化+クリーニング）
3D構築（スライスを積む）
   ↓ 粒子分割（エロージョン+ウォーターシェッド）
   ↓ 接触解析（粒子どうしの接点数）
   ↓ r最適化（HHI/膝点/VI → Pareto+距離）
出力（volume.npy, labels_r*.npy, 結果CSV/可視化）
```

- 実装対応（主な場所）:
  - `scripts/run_pipeline.py`: 一連の処理の司令塔
  - `src/particle_analysis/processing.py`: 前処理
  - `src/particle_analysis/volume/core.py`: 3D 構築・分割
  - `src/particle_analysis/contact/core.py`: 接触数
  - `src/particle_analysis/volume/metrics/`: 指標（HHI/VI 等）
  - `src/particle_analysis/volume/optimization/`: 膝点・最適化
  - `src/particle_analysis/gui/`: GUI 表示と可視化

---

## 4. 各ステップの中身（やさしく）

- **前処理**: 画像を見やすくして、粒子の場所を白黒で抽出
- **3D 構築**: 2D の積み重ねから 3D の箱（ボクセル）を作成
- **粒子分割**: くっついた粒子を“ほどよく”離す（r が分割の強さ）
- **接触解析**: 粒子どうしが何か所で触れているか数える
- **r 最適化**: 客観的な 3 つの指標で良い r 候補を絞り、最終 1 つに決める

---

## 5. r を決める 3 つの指標（数式・直感・意義）

### 5.1 HHI（支配性: Herfindahl–Hirschman Index）

- **数式**: 粒子体積のシェアを \(s_i\) とすると、\(\mathrm{HHI} = \sum_i s_i^2\)
- **直感**: 「一人勝ちがあるか？」（1 個がほとんどを占めると大）
- **意義**: 未分割の巨大粒子が残っていないかを検出（小さいほど良い）
- **コード**: `volume/metrics/dominance.py` の `calculate_hhi`

### 5.2 膝点距離（Knee Point Distance）

- **背景**: r を大きくすると粒子数が増えたのち頭打ちになる。「曲がり角=膝」を探す
- **近似**: 正規化カーブと対角線の差が最大の点を膝とみなす
- **数式イメージ**: 正規化後の \(y - x\) が最大のインデックスを膝 \(k\) とし、各 r の距離は \(|i - k|\)
- **意義**: 「やり過ぎ」や「やり足りない」を避け、適度な複雑さを選ぶ
- **コード**: `volume/optimization/utils.py` の `detect_knee_point`

### 5.3 VI（安定性: Variation of Information）

- **数式**: 2 つの分割 \(X,Y\) に対し、\(\mathrm{VI}(X,Y) = H(X) + H(Y) - 2 I(X;Y)\)
  - \(H\): エントロピー、\(I\): 相互情報量（いずれも base-2）
- **直感**: 「少し r を変えたら結果が激変しないか？」（小さいほど安定）
- **意義**: 過渡的な不安定領域を避け、再現性のある r を選ぶ
- **コード**: `volume/metrics/stability.py` の `calculate_variation_of_information`

> 注: HHI は「1 つが支配していないか」を測る“分布の偏り”指標、VI は「2 つの結果がどれだけ似ているか」を測る“比較の距離”。目的も単位も別物。

---

## 6. HHI と VI の違い（よく混同するポイント）

- **対象**:
  - HHI: 1 つの分割内部の“粒子サイズ分布の偏り”
  - VI: 2 つの分割間の“情報的な違い（距離）”
- **値の解釈**:
  - HHI: 小さいほど均等（未分割がない）
  - VI: 小さいほど類似（隣接 r で安定）
- **用途**:
  - HHI: 未分割・巨大粒子の検出に強い
  - VI: r をずらした時の一貫性チェックに強い

---

## 7. 多目的最適化（Pareto + 距離最小化）

### 考え方（2 段階）

```
[1] Pareto最適: どの指標でも他に完全に負けない候補だけ残す
[2] 距離最小化: 残った候補から「理想点(0,0,0)」に最も近いものを選ぶ
```

- 正規化した目的ベクトルを \((\mathrm{HHI}_n, d_{\text{knee},n}, \mathrm{VI}_n)\) とすると、
  距離は \(\sqrt{\mathrm{HHI}\_n^2 + d_{\text{knee},n}^2 + \mathrm{VI}\_n^2}\)
- タイブレーク: 小さい r → 低い生の HHI → 目標接触数（6 前後）に近い順
- **コード**: `volume/optimization/algorithms.py` の `determine_best_radius_pareto_distance`

### 例（r=6 と r=7 の比較イメージ）

- r=6: HHI が極小、膝点距離も小、VI は中程度 → 理想点に近い
- r=7: HHI は同等、膝点距離がやや増加、VI は改善 → 総合距離は僅差で r=6 勝ち

---

## 8. GUI での“見える化”

- テーブル: r ごとの「粒子数・平均接触数・HHI・膝点距離・VI」を表示
- グラフ: HHI vs r、膝点距離 vs r、VI vs r、Pareto 前線
- ハイライト: 最適 r を ★ 表示（説明テキスト付き）
- 実装: `src/particle_analysis/gui/widgets.py`, `main_window.py`

---

## 9. 出力の一覧と読むポイント

- `output/run_*/volume.npy`: 3D ボリューム
- `output/run_*/labels_r*.npy`: 各 r の分割結果
- `output/run_*/optimization_results.csv`: r ごとの指標まとめ
- `output/run_*/contact_counts.csv`: 各粒子の接触数
- `output/run_*/contacts_summary.csv`: 接触統計の要約

読むポイント:

- まず `optimization_results.csv` で r と各指標の関係を見る
- 次に `labels_r{best}.npy` を 3D 表示して妥当性を確認

---

## 10. 初心者向け Q&A

- Q: 「HHI が小さいのに VI が大きいのはなぜ？」
  - A: 分布は均等でも、“分割の対応関係”がずれていると VI は大きくなる。
- Q: 「膝点は絶対の正解？」
  - A: データ依存。過度なノイズ時は近傍傾向も併用して総合判断。
- Q: 「最適 r は毎回同じ？」
  - A: データや前処理が変われば変わる。仕組みは再現的だが結果はデータ次第。

---

## 11. まとめ（今日の持ち帰り）

- 目的: 「分け足りず/分け過ぎず」を避ける r を、客観指標で説明可能に選ぶ
- 3 指標の役割分担: HHI=未分割検出、膝点=やり過ぎ防止、VI=安定性
- 多目的最適化: 重み不要 → Pareto で候補抽出 → 距離で一意決定
- GUI で“見える化”し、結果の納得感を高める
