# 3D 粒子解析における最適分割パラメータ選定手法の改良と実装

## 1. 導入 (Introduction)

### 研究テーマ

**「より信頼性の高い最適分割パラメータ r の選定システムの構築」**

### 前月行ったこと

- 前月: GUI 対応 3D 粒子解析パイプラインの基礎開発

---

## 2. 背景と問題提起 (Background & Problem Definition)

### 3D 粒子解析パイプラインの概要

```
CT 画像 → 前処理 → 3D 構築 → エロージョン分割 → 接触解析 → 最適 r 決定
                                      ↑
                              今月の焦点: どの r が最適か？
```

### 先月の実験結果

**同一データで r=1 ～ 10 の分割を実行した結果：**

| r 値  | 粒子数   | 平均接触数 | 最大体積率 | 総合スコア |
| ----- | -------- | ---------- | ---------- | ---------- |
| 1     | 65       | 1.6        | 99.9%      | 0.082      |
| 5     | 1453     | 7.6        | 2.9%       | 0.940      |
| **6** | **1759** | **8.2**    | **0.9%**   | **0.994**  |
| 7     | 1734     | 8.3        | 0.5%       | 0.927      |
| 10    | 706      | 10.0       | 0.7%       | 0.686      |

→ **総合スコアで r=6 が最適と判定**

### 先月手法の問題点

**1. 恣意的な重み付け**

- 3 つの指標に対する重み（35% / 35% / 30%）に客観的根拠が不足
- 研究者の主観に依存する設定

**2. 固定閾値の根拠不足**

- 「平均接触数 6 ～ 8 が理想」の文献的裏付けが薄弱
- 「最大体積率 2 ～ 5%が適切」の普遍的根拠が不明確

**3. 説明可能性の欠如**

- 「なぜこの r が最適なのか？」を第三者に論理的に説明できない
- 重み付き総合スコアの物理的意味が不透明

---

## 3. 研究の目的 (Objective)

### 最終目標

**「信頼性が高く、誰でも納得できる最適 r 選定手法」の確立**

### 具体的な達成目標

**1. 恣意的重み付けからの脱却**

- 重み設定を排除し、多目的最適化（Pareto 最適化）を導入

**2. 信頼できる指標の導入**

- 経済学・情報理論など、学術的に認められた指標を採用
- 各指標の物理的意味を明確に定義し、説得力を向上

**3. GUI 可視化システムの構築**

- 新指標のリアルタイム表示
- Pareto 前線プロットによる最適解の可視化

---

## 4. 解決策 (Solution & Methodology)

### 新世代最適化手法: Pareto + 距離最小化

**基本コンセプト:**

- 重み付けを一切使用せず、複数の目的関数を同時に最適化
- 理想点（すべての指標が最良）への距離が最小の解を選択

**選定アルゴリズム:**

```
最適 r = argmin_{r ∈ Pareto前線} || objectives(r) - ideal ||₂
```

理想点 (0, 0, 0) への距離最小化による客観的選定

### 3 つの指標

**1. HHI 支配性指標（Herfindahl-Hirschman Index）**

- **文献**: 経済学の市場集中度指標（Hirschman 1945, Herfindahl 1950）
- **物理的意味**: 粒子体積分布の不平等度を定量化
  - HHI > 0.5 → 未分割の巨大粒子が支配的
  - HHI < 0.01 → 理想的な粒子分散状態
- **簡単に言うと**:
  - 「1 つの大きな塊が残っているか？」をチェックする指標
  - 例: クラスで 1 人だけが資産の 90%を持っている → 不平等（HHI が大きい）
  - 理想: みんなが同じくらいの大きさの粒子 → 平等（HHI が小さい）

**2. 膝点距離（Knee Point Distance）**

- **文献**: Kneedle Algorithm（Satopaa et al. 2011）
- **物理的意味**: 粒子数増加が飽和する「最適複雑度」の検出
  - 膝点距離 = 0 → 粒子数安定領域の正確な検出
  - 過分割（不自然な細分化）を防止
- **簡単に言うと**:
  - 「粒子数が急激に増える → ゆるやかになる」転換点を見つける
  - 例: 参考書を買うほど成績が上がるが、10 冊目からは効果が薄い → 「膝」
  - 理想: ちょうど粒子数が安定し始める r を選ぶ（やりすぎない）

**3. VI 安定性（Variation of Information）**

- **文献**: 情報理論的距離（Meilă 2007）
- **物理的意味**: 隣接する r 値間の分割一貫性を評価
  - VI が小さい → 安定した分割結果
  - VI が大きい → 不安定な過渡領域
- **簡単に言うと**:
  - 「r を少し変えただけで結果が激変するか？」をチェックする指標
  - 例: r=5 と r=6 で粒子の分かれ方が全然違う → 不安定（VI が大きい）
  - 理想: r を少し変えても結果が似ている → 安定（VI が小さい）

### Pareto + 距離最小化アルゴリズム

**基本概念: 2 段階の選定プロセス**

```
【ステップ1】Pareto最適化 → 候補を絞る
【ステップ2】距離最小化 → 最終決定する
```

#### ステップ 1: Pareto 最適化（候補の絞り込み）

**定義:**
「他のどの r と比べても、すべての指標で劣っていない」r を選ぶ

**スマホ購入の例え:**

| スマホ | 価格    | バッテリー | カメラ性能 | 判定           |
| ------ | ------- | ---------- | ---------- | -------------- |
| A      | 3 万円  | 10 時間    | ⭐⭐       | ❌ 性能低い    |
| B      | 5 万円  | 20 時間    | ⭐⭐⭐⭐   | ✅ Pareto 最適 |
| C      | 8 万円  | 25 時間    | ⭐⭐⭐⭐⭐ | ✅ Pareto 最適 |
| D      | 10 万円 | 24 時間    | ⭐⭐⭐⭐   | ❌ C より劣る  |

→ B と C だけが「これ以上改善できない」選択肢

**実験結果での適用:**

| r 値  | HHI       | 膝点距離 | VI        | Pareto 判定        |
| ----- | --------- | -------- | --------- | ------------------ |
| 1     | 0.998     | 5.0      | 0.500     | ❌ すべて悪い      |
| 4     | 0.592     | 2.0      | 2.161     | ❌ すべて悪い      |
| 5     | 0.003     | 1.0      | 6.855     | ❌ VI が大きすぎ   |
| **6** | **0.001** | **0.0**  | **1.049** | ✅ **Pareto 最適** |
| **7** | **0.001** | **1.0**  | **0.460** | ✅ **Pareto 最適** |
| 8     | 0.001     | 2.0      | 0.475     | ❌ r7 より劣る     |
| 10    | 0.002     | 4.0      | 0.890     | ❌ すべて悪い      |

→ **r=6 と r=7 が候補に残る**

#### ステップ 2: 距離最小化（最終決定）

**理想点の設定:**

```
理想点 = (HHI=0, 膝点距離=0, VI=0)
         完璧な分散  膝点ピッタリ  完全安定
```

**距離の計算式:**

```
距離 = √(HHI² + 膝点距離² + VI²)
```

**Pareto 前線候補の比較:**

| r 値 | HHI   | 膝点距離 | VI    | 理想点からの距離                    | 判定        |
| ---- | ----- | -------- | ----- | ----------------------------------- | ----------- |
| 6    | 0.001 | 0.0      | 1.049 | √(0.001² + 0² + 1.049²) = **1.049** | ✅ **最適** |
| 7    | 0.001 | 1.0      | 0.460 | √(0.001² + 1² + 0.460²) = **1.101** | ❌          |

**結論: r=6 が理想点に最も近い → 最適解に決定！**

#### なぜこの方法が優れているのか？

**1. 恣意的な重み付けが不要**

```
❌ 従来法: 総合スコア = 0.35×HHI + 0.35×膝点 + 0.30×VI
           ↑ なぜ35%? 30%? 根拠は？

✅ 新手法: 距離 = √(HHI² + 膝点距離² + VI²)
           ↑ すべての指標を平等に扱う（数学的に厳密）
```

**2. 2 段階フィルタリングの利点**

- **Pareto 最適化**: 明らかに劣る選択肢を排除

  - r=1 ～ 4: 分割不足 → 除外
  - r=5: HHI は良いが VI が不安定 → 除外
  - r=8 ～ 10: 他の r より劣る → 除外

- **距離最小化**: 残った「良い候補」の中から最良を選ぶ
  - r=6 vs r=7 の厳密な比較
  - 理想点への近さという客観的基準

**3. 説明可能性の向上**

```
「なぜ r=6 が最適なのか？」
→ Pareto前線上で理想点に最も近いから（距離1.049）
→ 数学的に証明可能、第三者に論理的に説明可能
```

### システムアーキテクチャの改善

**モジュール構造の再設計:**

```
volume/
├── metrics/        # 指標計算
│   ├── basic.py    # 基本メトリクス
│   ├── dominance.py # HHI・ジニ係数
│   └── stability.py # VI・Dice 係数
└── optimization/   # 最適化アルゴリズム
    ├── utils.py    # 膝点検出
    └── algorithms.py # Pareto 最適化
```

**GUI の責務分離:**

- 画像処理ロジックを `PipelineHandler` に分離
- UI コンポーネントと処理ロジックの明確な分離
- YAML 設定ファイル対応、エラーハンドリング強化

---

## 5. 結果と考察 (Results & Discussion)

### 実験結果: 新指標による分析

**同一データ（r=1 ～ 10）での新手法による評価:**

| r 値  | 粒子数   | 平均接触数 | HHI       | 膝点距離 | VI 安定性 | 判定            |
| ----- | -------- | ---------- | --------- | -------- | --------- | --------------- |
| 1     | 65       | 1.6        | 0.998     | 5.0      | 0.500     | ❌ 未分割       |
| 2     | 99       | 2.0        | 0.990     | 4.0      | 0.062     | ❌ 未分割       |
| 3     | 316      | 2.7        | 0.919     | 3.0      | 0.489     | ❌ 未分割       |
| 4     | 602      | 4.3        | 0.592     | 2.0      | 2.161     | ⚠️ 部分分割     |
| 5     | 1453     | 7.6        | 0.003     | 1.0      | 6.855     | ✅ 理想的       |
| **6** | **1759** | **8.2**    | **0.001** | **0.0**  | **1.049** | ✅ **★ 最適**   |
| 7     | 1734     | 8.3        | 0.001     | 1.0      | 0.460     | ✅ 良好         |
| 8     | 1527     | 8.7        | 0.001     | 2.0      | 0.475     | ✅ 良好         |
| 9     | 1112     | 9.4        | 0.001     | 3.0      | 0.714     | ⚠️ 過分割の兆候 |
| 10    | 706      | 10.0       | 0.002     | 4.0      | 0.890     | ⚠️ 過分割       |

### 重要な発見

**1. r4→r5 での劇的な転換点**

- HHI: 0.592 → 0.003（**99% 改善**）
- 粒子数: 602 → 1453（**未分割塊の完全解消**）
- 物理的に意味のある分割状態への急激な変化

**2. r=6 が最適である 4 つの根拠**

- **膝点距離 = 0.0**: 粒子数安定領域の正確な検出
- **HHI = 0.001**: 理想的な粒子分散状態（< 0.01）
- **平均接触数 = 8.2**: 物理的妥当性の範囲内（目標 6 ～ 8 に近接）
- **VI 安定性 = 1.049**: 隣接 r との一貫性確保

**3. 手法の比較**

- 先月の手法: r=6 を選定（総合スコア 0.994）
- 今月の新手法: r=6 を選定（Pareto + 距離最小化）
- **結果の一致により手法の妥当性を確認**

### GUI 可視化システム

**実装機能:**

- HHI・膝点距離・VI 安定性のリアルタイム表示
- 平均接触数の追加表示
- Pareto 前線プロット（2D/3D）
- 最適 r のハイライト表示（★ マーク、金色背景）
- 3D 結果の可視化（Napari ビューアー統合）

---

## 6. 総括と今後の展望 (Conclusion & Future Work)

### 研究の総括

**目的の達成:**

- ✅ 恣意的重み付けからの完全脱却
- ✅ 文献ベース客観的指標の確立
- ✅ Pareto 最適化による多目的同時最適化の実現
- ✅ GUI 可視化システムの構築

**技術的成果:**

- 3 つの新指標（HHI・膝点距離・VI 安定性）の統合実装
- Pareto + 距離最小化アルゴリズムの開発
- モジュール構造の再設計（metrics/, optimization/）
- GUI 責務分離とエラーハンドリング強化

### 学術的・実用的インパクト

**学術的貢献:**

- 3D 粒子解析分野における方法論的革新
- 経済学・情報理論の粒子解析への新適用
- 説明可能な AI（XAI）の考え方を反映した客観的手法

**実用的価値:**

- GUI による直感的な理解と操作性の向上
- 第三者による検証・再現が容易
- 自動化による人的判断への依存を最小化

### 今後の展望

**1. パイプラインの一元化**

- 現状: 事前に二値化された画像が必要
- 改善: 生の CT 画像から二値化まで含めた完全自動化
- 参考: 酒井先輩の二値化コードを統合

**2. 安定性の向上**

- 現状: 3D 構築が失敗する場合がある
- 改善: エラーハンドリングとリトライ機構の強化
- 目標: より堅牢なパイプライン実装

**3. 検証データの拡充**

- 現状: 単一データセットでの検証のみ
- 改善: 複数の異なるデータセットでの動作確認
- 目標: 汎用性の実証と手法の信頼性向上

---
